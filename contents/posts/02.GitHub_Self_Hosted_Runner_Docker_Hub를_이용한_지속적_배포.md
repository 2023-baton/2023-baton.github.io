---
title: "ğŸ’¿ ì§€ì†ì  ë°°í¬(CD)ë¥¼ GitHub Self Hosted Runnerì™€ Docker Hubë¡œ í•´ë³´ì"
description: "GitHub Self Hosted Runner + Docker Hub"
date: 2023-07-31
update: 2023-07-31
tags:
  - docker
  - github actions
  - self-hosted
series: "CD"
---

## ğŸ’¬ ê°œìš”

ë¨¼ì € ì§€ì†ì  ë°°í¬(CD, Continuous Deploy)ë¥¼ êµ¬ì¶•í•˜ê¸° ìœ„í•´ì„œ ë‹¤ìŒê³¼ ê°™ì€ ê¸°ìˆ ì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤.

-   GitHub Self Hosted Runner : í˜„ì¬ í´ë¼ìš°ë“œ ìƒí™©ì— ì í•©í•˜ë‹¤.
-   Docker Hub : EC2 ë‚´ë¶€ì—ì„œ ìŠ¤í”„ë§ í”„ë¡œì íŠ¸ê°€ ë¹Œë“œ(build)ëœ ì´ë¯¸ì§€(Image)ë¥¼ ê°€ì ¸ì™€ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤.

![image](https://github.com/2023-baton/2023-baton.github.io/assets/82203978/ae049740-d32f-4aac-9d4d-8c20ba042e11)

<br>
<br>
<br>

## **âœ… GitHub Self Hosted Runner**ë¥¼ ì„ íƒí•œ ì´ìœ 

í˜„ì¬ ì§„í–‰í•˜ê³  ìˆëŠ” í”„ë¡œì íŠ¸ì˜ í´ë¼ìš°ë“œ í™˜ê²½ì— ê°€ì¥ ì í•©í•˜ë‹¤ê³  ëŠê¼ˆë‹¤.

ì‚¬ìš©í•˜ê³  ìˆëŠ” EC2ì˜ vpc í™˜ê²½ì€ ì™¸ë¶€ì—ì„œ ë‚´ë¶€ë¡œ ë“¤ì–´ì˜¬ ìˆ˜ ìˆëŠ” ipì™€ portê°€ ì œí•œëœ ìƒíƒœì˜€ë‹¤.

ë•Œë¬¸ì— GitHub Actionsì˜ ì›Œí¬í”Œë¡œìš°(workflow)ë¥¼ ì´ìš©í•˜ì—¬ scp ëª…ë ¹ì–´ë¡œ ë¹Œë“œëœ jarë¥¼ ì „ì†¡í•˜ê±°ë‚˜ AWSì— ì ‘ê·¼í•´ì„œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì§ì ‘ ì‹¤í–‰í•˜ëŠ” ê²ƒì´ ë¶ˆê°€ëŠ¥í–ˆë‹¤.

ì¦‰, EC2 ë‚´ë¶€ì—ì„œ ì§€ì†ì  ë°°í¬ë¥¼ ì§„í–‰í•˜ê¸° ìœ„í•´ì„œëŠ” EC2 ë‚´ë¶€ì—ì„œ ì™¸ë¶€ë¡œ ì ‘ê·¼í•˜ëŠ” ë°©ì‹ì´ í•„ìš”í–ˆë‹¤.

ì´ ë•Œ ì‚¬ìš©í•´ë³¸ ê²½í—˜ì´ ìˆëŠ” ë„êµ¬ëŠ” ë‘ ê°€ì§€ì˜€ëŠ”ë°

ë°”ë¡œ Jenkinsì™€ GitHub Self Hosted Runner ì˜€ê³  ë‚˜ëŠ” í›„ìì¸ GitHubë¥¼ ì„ íƒí–ˆë‹¤.

Jenkinsì— ë¹„í•´ ëŸ¬ë‹ ì»¤ë¸Œê°€ ì ê³  GitHubì™€ ì—°ë™ì´ ì˜ë˜ì–´ ìˆì–´ ë¬¸ì œ í•´ê²°ì´ ì‰½ê¸° ë•Œë¬¸ì´ë‹¤.

Jenkinsê°€ í•„ìš”í•œ ìì›ë³´ë‹¤ GitHub Self Hosted Runnerê°€ ë” ì ë‹¤ëŠ” ì¥ì ì„ ê°€ì§€ê³  ìˆë‹¤.

ë˜í•œ ê°™ì€ í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•˜ê³  ìˆëŠ” íŒ€ì›ë“¤ì—ê²Œ GitHubë¥¼ ì„¤ëª…í•˜ì—¬ ê¸°ìˆ ì„ ì „íŒŒí•˜ëŠ” ê²ƒì´ Jenkins ë³´ë‹¤ ë” ì‰½ë‹¤ëŠ” ê²ƒë„ ì„ íƒí•œ ì´ìœ  ì¤‘ í•˜ë‚˜ë‹¤.

<br>
<br>
<br>

## **âœ… ğŸ³ Docker Hub**ë¥¼ ì„ íƒí•œ ì´ìœ 

AWSì—ì„œ EC2ë¥¼ ë„ì–´ ì‚¬ìš©í•˜ê³  ìˆëŠ” ìƒíƒœì—ì„œ ìŠ¤í”„ë§ í”„ë¡œì íŠ¸ë¥¼ í´ë¡  ë°›ì•„ ë¹Œë“œí•˜ëŠ” ê²½ìš° EC2 ë©”ëª¨ë¦¬ê°€ ë¶€ì¡±í•´ì§ˆ ìˆ˜ë„ ìˆë‹¤.

ì´ëŸ¬í•œ ìœ„í—˜ì„±ì„ ì¤„ì´ê¸° ìœ„í•´ì„œ ë¯¸ë¦¬ ë¹Œë“œëœ jar íŒŒì¼ì„ ê°€ì ¸ì™€ì„œ ì‹¤í–‰ì‹œí‚¤ë„ë¡ í–ˆë‹¤.

í•˜ì§€ë§Œ í˜„ì¬ í´ë¼ìš°ë“œ í™˜ê²½ì€ ë¹Œë“œëœ jarë¥¼ ë°”ë¡œ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ë‹¤.

AWSì—ì„œ ì œê³µí•˜ëŠ” S3ì™€ ê°™ì€ ê¸°ìˆ ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³  jar íŒŒì¼ì„ ë‹¤ìš´ë°›ì•„ ì‹¤í–‰ì‹œì¼œì•¼ í–ˆë‹¤.

ë˜í•œ ì €í¬ëŠ” í•˜ë‚˜ì˜ EC2ì—ì„œ React, Nginx, Springì„ ê°™ì´ ë„ì›Œ ë†“ì„ê±°ê¸° ë•Œë¬¸ì— ì´í›„ì— ê¼¬ì´ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ í™˜ê²½ì„ ë…ë¦½ì ìœ¼ë¡œ ê°€ì ¸ê°ˆ ìˆ˜ ìˆì—ˆìœ¼ë©´ í–ˆë‹¤.

ì´ëŸ¬í•œ ìƒí™©ì„ ë´¤ì„ ë•Œ ì»¨í…Œì´ë„ˆë¡œ í™˜ê²½ì„ ì œê³µí•´ì£¼ë©´ì„œ ë¹Œë“œëœ ì´ë¯¸ì§€(image)ë¥¼ í’€(pull)ë°›ì•„ ì„œë²„ë¥¼ ì‹¤í–‰ì‹œí‚¬ ìˆ˜ ìˆëŠ” ë„ì»¤(ğŸ³ Docker)ë¥¼ ì„ íƒí•˜ê¸°ë¡œ í–ˆë‹¤.

> ê¸°ìˆ ì´ ì •í•´ì¡Œê³  ëŒ€ëµì ì¸ í”Œë¡œìš°ë„ ë‚˜ì™”ë‹¤.  
> ğŸ¤” ê·¸ë ‡ë‹¤ë©´ ì´ì œ ë¬´ìŠ¨ ì¼ì„ í•´ì•¼ í• ê¹Œ?

ì´ë¡ ì ìœ¼ë¡œ í˜„ì¬ í”Œë¡œìš°ì— ëŒ€í•´ ì´í•´ëŠ” í•  ìˆ˜ ìˆì—ˆì§€ë§Œ ì‹¤ì œë¡œ ê¸°ìˆ ì„ ì‚¬ìš©í•´ë³¸ì ì€ ì—†ê¸° ë•Œë¬¸ì— ë¨¼ì € ê¸°ì¡´ í”Œë¡œìš°ë¥¼ ë‹¤ì‹œ í•œ ë²ˆ ì •ë¦¬í•˜ë©´ì„œ í•´ì•¼í•  ì¼ì„ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¡œ ë§Œë“¤ì—ˆë‹¤.

ğŸ’¬ ë¨¼ì € í”Œë¡œìš°ë¥¼ ì •ë¦¬í•´ë³´ì.

-   GitHub Repositoryì˜ ë¸Œëœì¹˜ì— push ë˜ì—ˆì„ ë•Œ GitHubê°€ ì¸ì§€í•˜ê³  ìŠ¤í”„ë§ í”„ë¡œì íŠ¸ë¥¼ ë¹Œë“œ(build)í•œë‹¤.
-   ë¹Œë“œëœ jaríŒŒì¼ì„ ë„ì»¤ ì´ë¯¸ì§€(Docker Image)ë¡œ ë§Œë“¤ì–´ ë„ì»¤ í—ˆë¸Œ(Docker Hub)ì— pushí•œë‹¤.
-   EC2ì— ë„ìš´ GitHub Self Hosted Runnerê°€ ë„ì»¤ í—ˆë¸Œê°€ ì—…ë°ì´íŠ¸ ë˜ì—ˆë‹¤ëŠ” ê²ƒì„ í™•ì¸í•˜ê³  ë„ì»¤ ì´ë¯¸ì§€ë¥¼ ìë™ìœ¼ë¡œ pullí•œë‹¤.
-   EC2ì— ìˆëŠ” ë„ì»¤ ì´ë¯¸ì§€ë¥¼ ì»¨í…Œì´ë„ˆë¡œ ë„ì›Œ ìŠ¤í”„ë§ ì„œë²„ë¥¼ ì‹¤í–‰ì‹œí‚¨ë‹¤.

í”Œë¡œìš°ë¥¼ ì‘ì„±í•˜ê³  íë¦„ì€ ì´í•´ ë˜ì—ˆë‹¤. ì´ì œ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ì‘ì„±í•˜ë©´ì„œ êµ¬ì²´í™” ì‹œì¼œë³´ì.

âœ”ï¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

\- ê¹ƒí—ˆë¸Œê°€ ì œê³µí•˜ëŠ” í´ë¼ìš°ë“œ í™˜ê²½ì—ì„œ í•  ì¼

Â  - GitHub Repository í´ë¡ 

Â  - JDK 17 í™˜ê²½ ì„¤ì •

Â  - Gradle Build

Â  - Docker Buildx

Â  - Docker Login

Â  - Docker Image Build

Â  - Docker Hub Push

\- EC2 ë‚´ë¶€ì— ìˆëŠ” GitHub Self Hosted Runnerê°€ í•  ì¼Â 

Â  - Docker Login

Â  - Docker Pull

Â  - Docker Run

ì´ì œ ì´ íë¦„ì„ ë”°ë¼ê°€ë³´ì.

<br>
<br>
<br>

## ğŸŸ© ê¹ƒí—ˆë¸Œê°€ ì œê³µí•˜ëŠ” í´ë¼ìš°ë“œ í™˜ê²½ì—ì„œ í•  ì¼

ë¨¼ì € '**ê¹ƒí—ˆë¸Œê°€ ì œê³µí•˜ëŠ” í´ë¼ìš°ë“œ í™˜ê²½ì—ì„œ í•  ì¼**'ì„ ëë‚´ë³´ì.

### 01\. on: push : branches: \["dev/BE"\]

workflowë¥¼ íŠ¸ë¦¬ê±°(trigger)í•˜ê¸° ìœ„í•´ì„œëŠ” ì´ë²¤íŠ¸(event)ë¥¼ ë°œìƒì‹œì¼œì•¼ í•œë‹¤.

í˜„ì¬ 'dev/BE' ë¸Œëœì¹˜ì— push ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ workflowê°€ ë™ì‘í•´ì•¼ í•œë‹¤.

ê¹ƒí—ˆë¸Œì—ì„œëŠ” ì´ëŸ¬í•œ push ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ workflowê°€ íŠ¸ë¦¬ê±°í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•˜ëŠ” ëª…ë ¹ì–´ë¥¼ ë¬¸ì„œì— ì •ë¦¬í•´ë‘ì—ˆë‹¤.

ì‚¬ìš©ì ì…ì¥ì—ì„œëŠ” workflowì— ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í•˜ë©´ ëœë‹¤.

```
on:
  push:
    branches: [ "dev/BE" ]
```

Â [ì›Œí¬í”Œë¡œë¥¼ íŠ¸ë¦¬ê±°í•˜ëŠ” ì´ë²¤íŠ¸ - GitHub Docs](https://docs.github.com/ko/actions/using-workflows/events-that-trigger-workflows#push)

<br>
<br>

### 02\. jobs: build: runs-on: ubuntu-latest

workflowë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” í™˜ê²½ì„ ëŸ¬ë„ˆ(runner)ë¼ê³  í•œë‹¤.

ê·¸ë¦¬ê³  workflow ë‚´ë¶€ì— ì‘ì—…(job)ë“¤ì„ ì§„í–‰í•˜ê¸° ìœ„í•´ì„œëŠ” ìš´ì˜ì²´ì œì™€ ê°™ì€ í™˜ê²½ì„ ë§Œë“¤ì–´ì¤˜ì•¼ í•œë‹¤.

MacOS, Window í™˜ê²½ì—ì„œ ì‘ì—…ì„ ì§„í–‰í•  ìˆ˜ ìˆì§€ë§Œ EC2ê°€ Linuxë¡œ ë„ì–´ì ¸ìˆê¸° ë•Œë¬¸ì— Ubuntuë¥¼ ì´ìš©í•˜ê¸°ë¡œ í•œë‹¤.

workflowì—ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í•˜ë©´ ëœë‹¤.

```
jobs:
  build:
    runs-on: ubuntu-latest
```

Â [GitHub í˜¸ìŠ¤íŒ… ì‹¤í–‰ê¸° ì •ë³´ - GitHub Docs](https://docs.github.com/ko/actions/using-github-hosted-runners/about-github-hosted-runners)

<br>
<br>

### 03\. uses: actions/checkout

GitHub Actionsë¥¼ ì‚¬ìš©í•´ì„œ ìŠ¤í”„ë§ í”„ë¡œì íŠ¸ë¥¼ ë¹Œë“œí•˜ë ¤ë©´ ë¨¼ì € ê¸°ë³¸ì ì¸ íŒŒì¼ì„ í´ë¡ ë°›ì•„ì•¼ í•œë‹¤.

ì´ ìŠ¤í…ì„ í•˜ë‚˜ì˜ ì•¡ì…˜(Action)ìœ¼ë¡œ GitHub Marketplaceì—ì„œ ì œê³µí•˜ê³  ìˆë‹¤.

workflowì—ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í•˜ë©´ ëœë‹¤.

```
on:
  push:
    branches: [ "dev/BE" ]

jobs:
  build:
    runs-on: ubuntu-latest


# ìœ„ì— ì íŒ ë‚´ìš©ì€ depthë¥¼ ë³´ì—¬ì£¼ê¸° ìœ„í•´ ë”°ë¡œ ë¶„ë¦¬í•˜ì§€ ì•Šì•˜ë‹¤.
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
```

Â [Checkout - GitHub Marketplace](https://github.com/marketplace/actions/checkout)

<br>
<br>

### 04\. uses:Â actions/setup-java

JDK 17ë¥¼ ì‚¬ìš©í•˜ê³  ìˆëŠ” ìŠ¤í”„ë§ í”„ë¡œì íŠ¸ë¥¼ ë¹Œë“œí•˜ê¸° ìœ„í•´ì„œ JDKë¥¼ ì„¤ì¹˜í•˜ëŠ” ì•¡ì…˜ì„ ì‚¬ìš©í•œë‹¤.

workflowì—ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í•˜ë©´ ëœë‹¤.

```
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'corretto'
```

Â [Setup Java JDK - GitHub Marketplace](https://github.com/marketplace/actions/setup-java-jdk)

<br>
<br>

### 05\. uses: gradle/gradle-build-action

Gradleë¡œ ìŠ¤í”„ë§ í”„ë¡œì íŠ¸ë¥¼ ê´€ë¦¬í•˜ê³  ìˆë‹¤. Gradleì„ í†µí•´ì„œ í”„ë¡œì íŠ¸ë¥¼ ë¹Œë“œí•˜ë ¤ê³  í•œë‹¤.

Â workflowì—ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í•˜ë©´ ëœë‹¤.

```
      - name: Build with Gradle
        uses: gradle/gradle-build-action@v2.6.0
      - name: Execute Gradle build
        run: |
          cd backend/baton
          ./gradlew build
```

Â [Gradle Build Action - GitHub Marketplace](https://github.com/marketplace/actions/gradle-build-action)

<br>
<br>

### 06\. uses: docker/login-action

Docker Hubì— ë§Œë“  ì´ë¯¸ì§€ë¥¼ í‘¸ì‰¬í•˜ê¸° ìœ„í•´ì„œ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•œë‹¤.

Dockerì— ë¡œê·¸ì¸í•˜ê³  ê³„ì •ì—ì„œ í† í°ì„ ë§Œë“¤ì–´ì•¼ ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë‹¤.

ì•„ë˜ëŠ” ì•„ì§ í† í°ì„ ë§Œë“¤ì§€ ì•Šì€ ìƒíƒœì˜ í˜ì´ì§€ë‹¤.

![image](https://github.com/2023-baton/2023-baton.github.io/assets/82203978/b5684ce0-98a7-4a58-af17-8f7829338707)

í† í°ì„ ë§Œë“¤ì–´ì„œ GitHub Secretì— ë“±ë¡í•´ì„œ workflowì—ì„œ ì‚¬ìš©í•˜ë„ë¡ ì„¤ì •í–ˆë‹¤.

![image](https://github.com/2023-baton/2023-baton.github.io/assets/82203978/42caa09a-f2b3-4e0d-b778-b760d999555d)

ì°¸ê³ ë¡œÂ  workflowì—ì„œ secretì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” \`${{ secrets.ì´ë¦„ }}\`ì™€ ê°™ì€ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ë©´ ëœë‹¤.

workflowì—ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í•˜ë©´ ëœë‹¤.

```
      - name: Login to Docker Hub
        uses: docker/login-action@v2.2.0
        with:
          username: ${{ secrets.DOCKERHUB_DEV_USERNAME }}
          password: ${{ secrets.DOCKERHUB_DEV_TOKEN }}
```

Â [Docker Hub Container Image Library](https://hub.docker.com/)

Â [Docker Login - GitHub Marketplace](https://github.com/marketplace/actions/docker-login)

<br>
<br>

### 07\. run: docker build

Docker Imageë¥¼ ë§Œë“¤ê¸° ìœ„í•´ì„œ docker build ëª…ë ¹ì–´ë¥¼ ì‘ì„±í•œë‹¤.

í”„ë¡œì íŠ¸ ìµœìƒë‹¨ íŒ¨í‚¤ì§€ì— ë§Œë“¤ì–´ ë†“ì€ Dockerfileì„ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ ëª…ì‹œí–ˆë‹¤.

Dockerfile ë‚´ìš©ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.  
EC2 í™˜ê²½ì€ arm64v8ì´ë‹¤.

JDKëŠ” Corretto 17ì„ ì´ìš©í–ˆë‹¤.

jarë¥¼ ë³µì‚¬ê³  ìŠ¤í”„ë§ í”„ë¡œí•„ í™˜ê²½ ë³€ìˆ˜ë¥¼ devë¡œ ë‘ê³  ìŠ¤í”„ë§ ì„œë²„ë¥¼ ì‹¤í–‰ì‹œí‚¨ë‹¤.

```
FROM arm64v8/amazoncorretto:17

WORKDIR /app

COPY ./build/libs/baton-0.0.1-SNAPSHOT.jar /app/baton.jar

CMD ["java", "-jar", "-Dspring.profiles.active=dev", "baton.jar"]
```

workflowì—ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í•˜ë©´ ëœë‹¤.

```
      - name: Docker Image Build
        run: |
          cd backend/baton
          docker build --platform linux/arm64/v8 -t 2023baton/2023baton -f Dockerfile-dev .
```

### 08\. run: docker push

ì´ì œ ì´ë¯¸ì§€ë¡œ ë§Œë“  ìŠ¤í”„ë§ í”„ë¡œì íŠ¸ë¥¼ Docker Hubì— pushí•˜ì.

ë¨¼ì € Dockerì—ì„œ Repositoryë¥¼ ë§Œë“¤ì.

workflowì— \`docker push 2023baton/2023baton\` ì´ë¼ëŠ” ëª…ë ¹ì–´ê°€ ëª…ì‹œë˜ì–´ ìˆëŠ”ë°

\`docker push {docker\_username}/{docker\_repository\_name}\` í˜•íƒœë¡œ ëª…ì‹œí•˜ë©´ ëœë‹¤.

workflowì—ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í•˜ë©´ ëœë‹¤.

```
      - name: Docker Hub Push
        run: docker push 2023baton/2023baton
```

### 09\. \`**ê¹ƒí—ˆë¸Œê°€ ì œê³µí•˜ëŠ” í´ë¼ìš°ë“œ í™˜ê²½ì—ì„œ í•  ì¼\`** workflow ì¢…í•©

![image](https://github.com/2023-baton/2023-baton.github.io/assets/82203978/5140c7d1-362d-4ac7-a106-abd3dc646f65)

01 ~ 08 ê¹Œì§€ ì†Œê°œí•œ ìŠ¤í…ë“¤ì„ í•©ì³ í•˜ë‚˜ì˜ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‘ì„±í•˜ë©´ ì•„ë˜ì™€ ê°™ë‹¤.

```
on:
  push:
    branches: [ "dev/BE" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'corretto'

      - name: Build with Gradle
        uses: gradle/gradle-build-action@v2.6.0
      - name: Execute Gradle build
        run: |
          cd backend/baton
          ./gradlew build

      - name: Login to Docker Hub
        uses: docker/login-action@v2.2.0
        with:
          username: ${{ secrets.DOCKERHUB_DEV_USERNAME }}
          password: ${{ secrets.DOCKERHUB_DEV_TOKEN }}

      - name: Docker Image Build
        run: |
          cd backend/baton
          docker build --platform linux/arm64/v8 -t 2023baton/2023baton -f Dockerfile-dev .

      - name: Docker Hub Push
        run: docker push 2023baton/2023baton
```

<br>
<br>
<br>

## ğŸŸ© EC2 ë‚´ë¶€ì— ìˆëŠ” GitHub Self Hosted Runnerê°€ í•  ì¼

ì´ì œ Docker Hubì— ìŠ¤í”„ë§ ì´ë¯¸ì§€ê¹Œì§€ ì˜¬ë¼ê°€ ìˆë‹¤.

EC2ì— ìˆëŠ” GitHub Self Hosted Runnerê°€ Docker Hubì— ì´ë¯¸ì§€ë¥¼ pullí•´ì„œ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•˜ë„ë¡ workflowë¥¼ ì‘ì„±í•˜ì.

### 01\. GitHub Self Hosted Runner ì„¤ì¹˜

Repositoryì˜ Settinggsì— ë“¤ì–´ê°€ Actions íƒ­ì— Runnersë¥¼ ë“¤ì–´ê°€ì„œ \`New self-hosted runner\` ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ëª…ë ¹ì–´ë¥¼ ë³´ì—¬ì¤€ë‹¤.

![image](https://github.com/2023-baton/2023-baton.github.io/assets/82203978/d29a74d2-cd05-482d-9570-8daff8d0e414)

ë‹¤ìŒê³¼ ê°™ì´ Runner Imageë¥¼ ê³ ë¥¼ ìˆ˜ ìˆê³  ë‹¤ìš´ë¡œë“œ, ì„¤ì •, ì‹¤í–‰ ë“± ì˜ ì •ë³´ë¥¼ ì „ë¶€ ì œê³µí•´ì£¼ê¸° ë•Œë¬¸ì— EC2ì— ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ë©´ ëì´ë‹¤.

![image](https://github.com/2023-baton/2023-baton.github.io/assets/82203978/9f8cdb9e-0b19-4027-bf66-4ee4350e3bd9)

### 02\. runs-on: \[self-hosted\]

EC2ì— GitHub Self Hosted Runnerë¥¼ ì„¤ì¹˜í–ˆë‹¤ë©´ workflowë¥¼ ì‘ì„±í•´ì£¼ì.

\`self-hosted\`ë¼ê³  ì‘ì„±í•˜ë©´ ìš°ë¦¬ê°€ ë°©ê¸ˆ ë§Œë“  runnerë¥¼ ì„ íƒí•˜ê²Œ ëœë‹¤.

ë§Œì•½ ë‹¤ìŒê³¼ ê°™ì´ Self-Hosted Runnerê°€ ë‘ ê°œ ì´ìƒì´ë¼ë©´ ë¼ë²¨(label)ì„ ë„£ì–´ì„œ êµ¬ë¶„í•  ìˆ˜ ìˆë‹¤.

![image](https://github.com/2023-baton/2023-baton.github.io/assets/82203978/d18331d0-15bf-4b3c-ac19-817065076ac7)

ë‹¤ìŒê³¼ ê°™ì€ ìƒí™©ì—ì„œ ë‚˜ëŠ” deploy í™˜ê²½ì—ì„œëŠ” deployë¼ëŠ” ë¼ë²¨ì„ ë¶™ì˜€ë‹¤.

![image](https://github.com/2023-baton/2023-baton.github.io/assets/82203978/b5340890-b187-44d1-bc0a-c9a86e08e93b)

runnerê°€ 1ê°œ ì¼ ë•ŒëŠ” workflowëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í•  ìˆ˜ ìˆë‹¤.

```
jobs:
  dev-deploy:
    runs-on: self-hosted
```

runnerê°€ 2ê°œ ì´ìƒì¼ ë•ŒëŠ” êµ¬ë¶„ì§€ì„ ìˆ˜ ìˆì–´ì•¼ ë˜ê¸° ë•Œë¬¸ì— ì•„ë˜ì™€ ê°™ì´ ë¼ë²¨ê¹Œì§€ ëª…ì‹œí•´ì£¼ë©´ ëœë‹¤.

```
# Self-Hosted Runner : dev
jobs:
  dev-deploy:
    runs-on: [self-hosted, Linux, ARM64]
```

```
# Self-Hosted Runner : deploy 
jobs:
  dev-deploy:
    runs-on: [self-hosted, Linux, ARM64, deploy]
```

í˜„ì¬ ì›Œí¬í”Œë¡œìš°ì—ì„œ ì‚¬ìš©í•˜ëŠ” Self-Hosted RunnerëŠ” devë¼ëŠ” ê²ƒì„ ìƒê°í•´ì¤¬ìœ¼ë©´ ì¢‹ê² ë‹¤.

### 03\. needs: build

ì´ì „ì— Docker Hubì— ì´ë¯¸ì§€ë¥¼ pushí•˜ëŠ” ì‘ì—…ì´ ìˆì—ˆë‹¤.

ê·¸ë¦¬ê³  ì§€ê¸ˆ ì‘ì„±í•˜ê³  ìˆëŠ” ì‘ì—…ì€ EC2ì—ì„œ Docker Hub ì´ë¯¸ì§€ë¥¼ pull ë°›ì•„ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰ì‹œí‚¤ëŠ” ê²ƒì´ë‹¤.

ì´ ë•Œ ìˆœì„œë¥¼ ì •í•´ì£¼ì§€ ì•Šìœ¼ë©´ ì—…ë°ì´íŠ¸ ë˜ì§€ ì•Šì€ ì´ë¯¸ì§€ë¥¼ ë°›ì•„ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰ì‹œí‚¬ ìˆ˜ ë„ ìˆë‹¤.

ê·¸ëŸ¬í•œ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œ needsë¼ëŠ” í‚¤ì›Œë“œë¥¼ ë‹¬ì•„ buildë¼ëŠ” ì‘ì—…ì´ ëë‚˜ë©´ ë‹¤ìŒ ì‘ì—…ì´ ì§„í–‰ë˜ë„ë¡ ë§Œë“¤ì.

workflowì—ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í•˜ë©´ ëœë‹¤.

```
on:
  push:
    branches: [ "dev/BE" ]

jobs:
  build:
    runs-on: ubuntu-latest

  deploy:
    runs-on: [self-hosted, Linux, ARM64]
    needs: build
```

### 04\. docker pull

ì´ì œ Docker Hubì— ë¡œê·¸ì¸í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ pullí•˜ë„ë¡ í•˜ì.

Docker Hubì— 2023baton ë ˆí¬ì§€í„°ë¦¬ì—ì„œ 2023baton ì´ë¯¸ì§€ë¥¼Â  pullí•œë‹¤.

workflowëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í•˜ë©´ ëœë‹¤.

```
    steps:
      - name: Pull Latest Docker Image
        run: |
          sudo docker login --username ${{ secrets.DOCKERHUB_DEV_USERNAME }} --password ${{ secrets.DOCKERHUB_DEV_TOKEN }}
          sudo docker pull 2023baton/2023baton:latest
```

### 05\. docker run

Docker Imageê°€ pull ë°›ì•„ ìµœì‹  ìƒíƒœê°€ ëœ ê²½ìš° ìŠ¤í”„ë§ Containerë¥¼ ë©ˆì¶”ê³  ì‚­ì œí•œë‹¤.

ê·¸ë¦¬ê³  ë‹¤ì‹œ ìƒˆë¡œìš´ Containerë¥¼ ë„ìš°ë„ë¡ í•œë‹¤.

workflowëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í•˜ë©´ ëœë‹¤.

```
    steps:
      - name: Pull Latest Docker Image
        run: |
          sudo docker login --username ${{ secrets.DOCKERHUB_DEV_USERNAME }} --password ${{ secrets.DOCKERHUB_DEV_TOKEN }}
          if sudo docker inspect spring-baton &>/dev/null; then
            sudo docker stop spring-baton
            sudo docker rm -f spring-baton
          fi
          sudo docker pull 2023baton/2023baton:latest

      - name: Docker Run
        run: |
          sudo docker run --name spring-baton -p 8080:8080 2023baton/2023baton:latest 1>> build.log 2>> error.log &name: dev/BE CD on Push
```

#### 06\. \`**EC2 ë‚´ë¶€ì— ìˆëŠ” GitHub Self Hosted Runnerê°€ í•  ì¼**\` worflow ì¢…í•©

![image](https://github.com/2023-baton/2023-baton.github.io/assets/82203978/675fcde0-5e8e-4bab-aca5-d47a262329f4)

```
  deploy:
    runs-on: [self-hosted, Linux, ARM64]
    needs: build

    steps:
      - name: Pull Latest Docker Image
        run: |
          sudo docker login --username ${{ secrets.DOCKERHUB_DEV_USERNAME }} --password ${{ secrets.DOCKERHUB_DEV_TOKEN }}
          if sudo docker inspect spring-baton &>/dev/null; then
            sudo docker stop spring-baton
            sudo docker rm -f spring-baton
          fi
          sudo docker pull 2023baton/2023baton:latest

      - name: Docker Run
        run: |
          sudo docker run --name spring-baton -p 8080:8080 2023baton/2023baton:latest 1>> build.log 2>> error.log &
```

<br>
<br>
<br>

## ğŸŸ© ìµœì¢… ì›Œí¬í”Œë¡œìš°

```
name: dev/BE CD on Push

on:
  push:
    branches: [ "dev/BE" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.SUBMODULE_BE_TOKEN }}
          submodules: recursive

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'corretto'

      - name: Build with Gradle
        uses: gradle/gradle-build-action@v2.6.0
      - name: Execute Gradle build
        run: |
          cd backend/baton
          ./gradlew build

      - name: Login to Docker Hub
        uses: docker/login-action@v2.2.0
        with:
          username: ${{ secrets.DOCKERHUB_DEV_USERNAME }}
          password: ${{ secrets.DOCKERHUB_DEV_TOKEN }}

      - name: Docker Image Build
        run: |
          cd backend/baton
          docker build --platform linux/arm64/v8 -t 2023baton/2023baton -f Dockerfile-dev .

      - name: Docker Hub Push
        run: docker push 2023baton/2023baton

  deploy:
    runs-on: [self-hosted, Linux, ARM64]
    needs: build

    steps:
      - name: Pull Latest Docker Image
        run: |
          sudo docker login --username ${{ secrets.DOCKERHUB_DEV_USERNAME }} --password ${{ secrets.DOCKERHUB_DEV_TOKEN }}
          if sudo docker inspect spring-baton &>/dev/null; then
            sudo docker stop spring-baton
            sudo docker rm -f spring-baton
          fi
          sudo docker pull 2023baton/2023baton:latest

      - name: Docker Compose
        run: |
          sudo docker run --name spring-baton -p 8080:8080 2023baton/2023baton:latest 1>> build.log 2>> error.log &
```

ì´ì œ ë¸Œëœì¹˜ì— push í•  ë•Œ ë§ˆë‹¤ ìƒˆë¡œìš´ ì´ë¯¸ì§€ê°€ Docker Hubì— push ë˜ê³  Self-hostedëŠ” pull ë°›ì•„ ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆë¥¼ ë„ìš´ë‹¤.
